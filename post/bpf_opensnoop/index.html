<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Bpf_opensnoop - ooknn</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="ooknn"><meta name=description content><meta name=generator content="Hugo 0.68.3"><link rel=canonical href=https://ooknn.github.io/post/bpf_opensnoop/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.f7440b5c0d223f47a09bf5853465434e6f91d80a591c2f8d2d5e8220e5db0580.css integrity="sha256-90QLXA0iP0egm/WFNGVDTm+R2ApZHC+NLV6CIOXbBYA=" media=screen crossorigin=anonymous><meta property="og:title" content="Bpf_opensnoop"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://ooknn.github.io/post/bpf_opensnoop/"><meta property="article:published_time" content="2021-04-23T10:17:36+08:00"><meta property="article:modified_time" content="2021-04-23T10:17:36+08:00"><meta itemprop=name content="Bpf_opensnoop"><meta itemprop=description content><meta itemprop=datePublished content="2021-04-23T10:17:36+08:00"><meta itemprop=dateModified content="2021-04-23T10:17:36+08:00"><meta itemprop=wordCount content="660"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Bpf_opensnoop"><meta name=twitter:description content><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>ooknn</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://ooknn.github.io/>首页</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://ooknn.github.io/categories/>分类</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://ooknn.github.io/about/>我</a></li></ul></nav><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>ooknn</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://ooknn.github.io/>首页</a></li><li class=menu-item><a class=menu-item-link href=https://ooknn.github.io/categories/>分类</a></li><li class=menu-item><a class=menu-item-link href=https://ooknn.github.io/about/>我</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><article class="post bg-white"><header class=post-header><h1 class=post-title>Bpf_opensnoop</h1><div class=post-meta><time datetime=2021-04-23 class=post-time>2021-04-23</time></div></header><div class=post-content><p>我在 ubuntu 上使用 navicat,今天试用期结束了，想着怎么能继续使用,linux下一切皆文件，试用信息肯定放在一个文件中。遂跟踪 navicat 进程打开的文件,我用的是 btp 工具 opensnoop。传统linux工具strace一样可以</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>••• ~ ➜  sudo /usr/share/bcc/tools/opensnoop &gt; na.log
</code></pre></div><p>观察输出文件，发现 ~/.config 目录下有个 navicat 文件夹</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/sqlite/tls/haswell/x86_64/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/sqlite/tls/haswell/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/sqlite/tls/x86_64/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/sqlite/tls/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/sqlite/haswell/x86_64/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/sqlite/haswell/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/sqlite/x86_64/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/sqlite/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/oci/tls/haswell/x86_64/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/oci/tls/haswell/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/oci/tls/x86_64/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/oci/tls/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/oci/haswell/x86_64/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/oci/haswell/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/oci/x86_64/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/lib/oci/libdl.so.2
<span style=color:#ae81ff>23350</span>  navicat  -1   <span style=color:#ae81ff>2</span> ~/.config/navicat/Premium/ui_preferences.json

</code></pre></div><p>删除之后运行navicat发现还是提示试用结束,那就继续找,过滤掉 .config/navicat/ 文件夹之后，然后看在 .config 文件下还有哪些文件被打开</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>••• ~ ➜ awk <span style=color:#e6db74>&#39;$2==&#34;navicat15-premi&#34; || $2==&#34;navicat&#34; {print $0}&#39;</span> na.log | grep -v <span style=color:#e6db74>&#34;.config/navicat/&#34;</span> | grep <span style=color:#e6db74>&#34;/.config&#34;</span> 
<span style=color:#ae81ff>23367</span>  navicat <span style=color:#ae81ff>13</span>   <span style=color:#ae81ff>0</span> ~/.config/fcitx/dbus/428cc79e9c4d4f8393591702ea85d60e-1
<span style=color:#ae81ff>23350</span>  navicat <span style=color:#ae81ff>13</span>   <span style=color:#ae81ff>0</span> ~/.config/fcitx/dbus/428cc79e9c4d4f8393591702ea85d60e-1
<span style=color:#ae81ff>23350</span>  navicat <span style=color:#ae81ff>16</span>   <span style=color:#ae81ff>0</span> ~/.config/dconf/user
<span style=color:#ae81ff>23350</span>  navicat <span style=color:#ae81ff>21</span>   <span style=color:#ae81ff>0</span> ~/.config/dconf/user
<span style=color:#ae81ff>23350</span>  navicat <span style=color:#ae81ff>22</span>   <span style=color:#ae81ff>0</span> ~/.config/dconf/user
••• ~ ➜ 
••• ~ ➜ 
</code></pre></div><p>发现就剩 ~/.config/dconf/user 文件被打开访问了,dconf 类似windows下的注册表,可以通过 dconf-editor 或者 gsettings 进行查看</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mv ~/.config/dconf/user ~
</code></pre></div><p>移动 ~/.config/dconf/user 后，再次打开 navicat，发现重新提示试用开始。那么 navicat 一定是在 dconf/user 文件中写入了注册信息,接下来就是查找 navicat 究竟在 dconf/user 中写入了哪些信息</p><p>通过 dconf-editor 和 gsettings 查看 dconf 中的数据，没发现有用的信息</p><p>接下来通过 strace 跟踪 navicat 进程调用堆栈</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/run/dconf/user/1000&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
futex<span style=color:#f92672>(</span>0x7fd14d857f38, FUTEX_WAKE_PRIVATE, 2147483647<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/run/user/1000/dconf/profile&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/dconf/profile/user&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/usr/share/ubuntu/dconf/profile/user&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/usr/local/share/dconf/profile/user&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/usr/share/dconf/profile/user&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/var/lib/snapd/desktop/dconf/profile/user&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
futex<span style=color:#f92672>(</span>0x7fd14d857f38, FUTEX_WAKE_PRIVATE, 2147483647<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
access<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/run&#34;</span>, F_OK<span style=color:#f92672>)</span>                    <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/run&#34;</span>, <span style=color:#f92672>{</span>st_mode<span style=color:#f92672>=</span>S_IFDIR|0755, st_size<span style=color:#f92672>=</span>1420, ...<span style=color:#f92672>})</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
access<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/run/user&#34;</span>, F_OK<span style=color:#f92672>)</span>               <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/run/user&#34;</span>, <span style=color:#f92672>{</span>st_mode<span style=color:#f92672>=</span>S_IFDIR|0755, st_size<span style=color:#f92672>=</span>80, ...<span style=color:#f92672>})</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
access<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/run/user/1000&#34;</span>, F_OK<span style=color:#f92672>)</span>          <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/run/user/1000&#34;</span>, <span style=color:#f92672>{</span>st_mode<span style=color:#f92672>=</span>S_IFDIR|0700, st_size<span style=color:#f92672>=</span>1020, ...<span style=color:#f92672>})</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
access<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/run/user/1000/dconf&#34;</span>, F_OK<span style=color:#f92672>)</span>    <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
stat<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/run/user/1000/dconf&#34;</span>, <span style=color:#f92672>{</span>st_mode<span style=color:#f92672>=</span>S_IFDIR|0700, st_size<span style=color:#f92672>=</span>60, ...<span style=color:#f92672>})</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/run/user/1000/dconf/user&#34;</span>, O_RDWR|O_CREAT, 0600<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span>
pwrite64<span style=color:#f92672>(</span>15, <span style=color:#e6db74>&#34;\0&#34;</span>, 1, 1<span style=color:#f92672>)</span>                <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
mmap<span style=color:#f92672>(</span>NULL, 1, PROT_READ, MAP_SHARED, 15, 0<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> 0x7fd134067000
close<span style=color:#f92672>(</span>15<span style=color:#f92672>)</span>                               <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
futex<span style=color:#f92672>(</span>0x7fd14d857f38, FUTEX_WAKE_PRIVATE, 2147483647<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/home/gyl/.config/dconf/user&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span>
fstat<span style=color:#f92672>(</span>15, <span style=color:#f92672>{</span>st_mode<span style=color:#f92672>=</span>S_IFREG|0664, st_size<span style=color:#f92672>=</span>25691, ...<span style=color:#f92672>})</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
mmap<span style=color:#f92672>(</span>NULL, 25691, PROT_READ, MAP_PRIVATE, 15, 0<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> 0x7fd134060000
close<span style=color:#f92672>(</span>15<span style=color:#f92672>)</span>                               <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</code></pre></div></div><footer class=post-footer><nav class=post-nav><a class=next href=/post/io_context/><span class="next-text nav-default">Io_context</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"/></svg></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=icon-links><a href=https://ooknn.github.io/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a></span>
<span class=copyright-year>&copy;
2019 -
2021
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author>ooknn</span></span></div><script src=https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js></script><script src=https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin=anonymous></script><script>(function(){let plantumlPrefix="language-plantuml";Array.prototype.forEach.call(document.querySelectorAll("[class^="+plantumlPrefix+"]"),function(code){let image=document.createElement("IMG");image.loading='lazy';image.src='http://www.plantuml.com/plantuml/svg/~1'+plantumlEncoder.encode(code.innerText);code.parentNode.insertBefore(image,code);code.style.display='none';});})();</script><script type=text/javascript src=//cdn.bootcss.com/viz.js/1.8.0/viz.js></script><script type=text/javascript>(function(){var vizPrefix="language-viz-";Array.prototype.forEach.call(document.querySelectorAll("[class^="+vizPrefix+"]"),function(x){var engine;x.getAttribute("class").split(" ").forEach(function(cls){if(cls.startsWith(vizPrefix)){engine=cls.substr(vizPrefix.length);}});var image=new DOMParser().parseFromString(Viz(x.innerText,{format:"svg",engine:engine}),"image/svg+xml");x.parentNode.insertBefore(image.documentElement,x);x.style.display='none'});})();</script><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/vs.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script></body></html>